function P(){N(),$(document).on("change","#sort_mode",{},R),$(document).on("change","#elems_per_page",{},T)}function N(){if($myApp.sortModes[$myApp.productName]=$("#sort_mode").val(),$myApp.sortModes[$myApp.productName]=="random"){var t=$.cookie($myApp.productName+"_sort_mode");t&&($myApp.sortModes[$myApp.productName]=t,$("#sort_mode").val(t))}if($myApp.perPages[$myApp.productName]=+$("#elems_per_page").val(),$myApp.perPages[$myApp.productName]=="random"){var t=$.cookie($myApp.productName+"_per_page");t&&($myApp.perPages[$myApp.productName]=t,$("#elems_per_page").val(t))}}function R(t){$myApp.sortModes[$myApp.productName]=$(this).val(),$.cookie($myApp.productName+"_sort_mode",$myApp.sortModes[$myApp.productName],{expires:15,path:"/"});var e=new URL(window.location);window.location.href=e.href}function T(t){$myApp.perPages[$myApp.productName]=$(this).val(),$.cookie($myApp.productName+"_per_page",$myApp.perPages[$myApp.productName],{expires:15,path:"/"});var e=new URL(window.location);window.location.href.indexOf("page=")!==-1&&e.searchParams.set("page",1),window.location.href=e.href}function O(){$myApp.isAnyFiltersSelected&&g("REQUEST FILTER NUMBERS WHEN PAGE IS LOADED"),x("init"),$(document).on("click","[data-func=show_filters]",{btn_function:"show_filters"},g),$(document).on("click","[data-func=close_fullscreen_filters]",{btn_function:"close_fullscreen_filters"},g),$(document).on("click","[data-func=apply_diapason_filter]",{btn_function:"diapason_filter_clicked"},g),$(document).on("click","[data-func=clear_all_filters]",{btn_function:"clear_all_filters"},g),$(document).on("click","[data-func=apply_filters]",{btn_function:"apply_filters"},g),$(document).on("click",".input_checkbox_filter",{btn_function:"one_simple_filter_clicked"},g),$(document).on("mouseup",".btn_clear_filters",{btn_function:"clear_one_group_of_filters"},g),D()}function g(t){var e=$myApp.calculateFiltersUrl;if(t!="REQUEST FILTER NUMBERS WHEN PAGE IS LOADED"){t.stopImmediatePropagation();var n=$(this);switch(t.data.btn_function){case"clear_one_group_of_filters":U(n);break;case"clear_all_filters":L();break;case"one_simple_filter_clicked":E();break;case"diapason_filter_clicked":I(n);break;case"show_filters":H();return;case"close_fullscreen_filters":t.stopImmediatePropagation(),$("#filters_global_container").removeClass("h-100"),$("#filters_global_container").collapse("toggle"),$("body").css("pointer-events","auto");return;case"apply_filters":var e="";break}}var a=$(".btn_clear_filters").map(function(o,i){return $(i).hasClass("d-none")?null:1}).length>0;a?$("[data-func=clear_all_filters]").removeClass("d-none"):$("[data-func=clear_all_filters]").addClass("d-none");var r=$("input.input_checkbox_filter:checked").map((o,i)=>$(i).attr("code")).toArray(),c=$(".accordion-item[f_type=D]").map(function(o,i){i=$(i);var f=i.attr("code"),l=+i.find("#input_min_"+f).val(),s=+i.find("#input_max_"+f).val(),u=+i.find("#input_min_"+f).attr("placeholder"),h=+i.find("#input_max_"+f).attr("placeholder");return l>s&&(l=s,s=l),l<u&&(l=u),s>h&&(s=h),l==h&&(l=u,s=h),l<=u&&s>=h?null:[[f,l,s]]}).toArray();if(e==$myApp.calculateFiltersUrl)var d=p;else{$myApp.checkedFilters=r,$myApp.diapasonFilters=c,window.location.href=X();return}x("no toggle"),$.ajax({url:e,type:"POST",dataType:"json",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{checkedFilters:r,diapasonFilters:c,sort:$myApp.sortMode,perpage:$myApp.perPage,methodPOST:1},success:d,error:function(o,i,f){console.log("filter_click_handler > ОШИБКА AJAX запроса: "+i,o)}});function p(o,i,f){var l=o.filters.length;for(let _=0;_<l;_++){var s=o.filters[_],u=s[0];if(s.length==3){var h=s[1],m=s[2];$("#input_min_"+u).val(h),$("#input_max_"+u).val(m)}else $("#span2"+u).text(s[1])}$(".total_products_found").text(o.selectedItemsTotalCount),$("plural_products").text(pluralProducts(o.selectedItemsTotalCount));var v=new URLSearchParams(window.location.search),C="";if(r.length)for(let _=0;_<r.length;_++)C+=r[_],_<r.length-1&&(C+="-");C?v.set("ff",C):v.delete("ff");var k="";if(c.length)for(let _=0;_<c.length;_++)k+=c[_][0]+"_"+c[_][1]+"_"+c[_][2],_<c.length-1&&(k+="-");k?v.set("fd",k):v.delete("fd"),M(window.location.origin+window.location.pathname+"?"+v.toString())}}function x(t=""){!isMobileViewport()&&!t&&$("#show_filters").toggleClass("filters_closed");var e=$(".btn_clear_filters:not(.d-none)"),n=0;for(let r=0;r<e.length;r++){var a=+e.eq(r).find("span:first-of-type").text();n+=a}n?$("#show_filters").removeClass("no_filters_selected").find("span[selected_filters_cnt]").text(n):$("#show_filters").addClass("no_filters_selected")}function b(){$(".accordion-item[dependent]").each(function(t,e){e=$(e);var n=e.find("ul.depended_filters_list > li[belongs_to]").filter(function(a,r){r=$(r);var c=r.attr("belongs_to");return $("#input_checkbox"+c).prop("checked")?(r.removeClass("d-none"),!0):(r.addClass("d-none"),r.find("input").each(function(){$(this).prop("checked",!1)}),!1)});n.each(function(a,r){r=$(r),a%2?r.addClass("depended_even"):r.removeClass("depended_even")}),n.length?e.removeClass("d-none"):e.addClass("d-none")})}function M(t){history.pushState?history.pushState(null,null,t):console.warn("History API is not supported by your browser")}function U(t){var e=find_parent(t,"accordion-item");if(e.attr("f_type")=="D"){var n=e.attr("code"),a=e.find("#input_min_"+n),r=e.find("#input_max_"+n);a.val(a.attr("placeholder")).trigger("input"),r.val(r.attr("placeholder")).trigger("input")}else e.find(".input_checkbox_filter").prop("checked",!1);t.addClass("d-none"),b()}function L(){$(".btn_clear_filters").addClass("d-none"),$(".accordion-item").find("input.input_checkbox_filter:checked").prop("checked",!1),$(".accordion-item[f_type=D]").each(function(t,e){var n=$(e),a=n.attr("code"),r=n.find("#input_min_"+a),c=n.find("#input_max_"+a);r.val(r.attr("placeholder")),c.val(c.attr("placeholder"))}),b()}function E(){var t=$(".accordion-item");b();for(let r=0;r<t.length;r++){var e=t.eq(r);if(e.find("input.input_checkbox_filter").length){var n=e.find("input.input_checkbox_filter:checked"),a=e.find(".btn_clear_filters");n.length?(a.find("span").text(n.length),a.removeClass("d-none")):a.addClass("d-none")}}}function I(t){var e=$(".accordion-item[f_type=D]");for(let i=0;i<e.length;i++){var n=find_parent(t,"accordion-item"),a=n.find(".btn_clear_filters"),r=n.attr("code"),c=+n.find("#input_min_"+r).val(),d=+n.find("#input_max_"+r).val(),p=+n.find("#input_min_"+r).attr("placeholder"),o=+n.find("#input_max_"+r).attr("placeholder");c<p&&n.find("#input_min_"+r).val(p),d>o&&n.find("#input_max_"+r).val(o),c<=p&&d>=o?a.addClass("d-none"):(a.find("span").text(1),a.removeClass("d-none"))}}function H(){x();var t=$("#filters_global_container");t.collapse("toggle"),isMobileViewport()&&$("#filters_global_container ").hasClass("show")?($("body").css("pointer-events","auto"),t.removeClass("h-100")):isMobileViewport()&&($("body").css("pointer-events","none"),t.addClass("h-100"))}function D(){var t=$(".filter_diapason_wrapper");for(let l=0;l<t.length;l++){let s=function(u){o=u.from,i=u.to,this.inputMin.prop("value",o),this.inputMax.prop("value",i)};var f=s,e=t.eq(l).attr("code"),n=$("#filter-range-slider_"+e),a=t.eq(l).find("#input_min_"+e),r=t.eq(l).find("#input_max_"+e),c,d=a.attr("placeholder"),p=r.attr("placeholder"),o=a.val(),i=r.val();n.ionRangeSlider({skin:["flat","modern","round"][l%3],type:"double",min:d,max:p,from:o,to:i,inputMin:a,inputMax:r,onStart:s,onChange:s}),c=n.data("ionRangeSlider"),a.on("input",c,function(u){var h=$(this),m=+h.prop("value"),v=+h.attr("placeholder");m<v?m=v:m>i&&(m=i),u.data.update({from:m})}),r.on("input",c,function(u){var h=$(this),m=+h.prop("value"),v=+h.attr("placeholder");m<o?m=o:m>v&&(m=v),u.data.update({to:m})})}}function X(){var t="";if($myApp.checkedFilters.length||$myApp.diapasonFilters.length){var t="?";for(let a=0;a<$myApp.checkedFilters.length;a++)a==0&&(t+="ff="),t+=$myApp.checkedFilters[a],a<$myApp.checkedFilters.length-1&&(t+="-");$myApp.checkedFilters.length&&$myApp.diapasonFilters.length&&(t+="&");for(let a=0;a<$myApp.diapasonFilters.length;a++)a==0&&(t+="fd="),t+=$myApp.diapasonFilters[a][0]+"_"+$myApp.diapasonFilters[a][1]+"_"+$myApp.diapasonFilters[a][2],a<$myApp.diapasonFilters.length-1&&(t+="-")}var e=new URL(window.location.origin+window.location.pathname+t);return $myApp.sortMode&&e.searchParams.set("sort",$myApp.sortMode),$myApp.perPage&&e.searchParams.set("perpage",$myApp.perPage),e.href}function q(){$(document).on("click",".input_compare",{func:"compare_icon"},w),$(document).on("click",".input_favorite",{func:"favorite_icon"},w)}function w(t){t.stopImmediatePropagation();var e=$(this),n=e.prop("checked"),a=e.attr("carid");const r=$myApp.productName+"_compare_elems",c=$myApp.productName+"_favorites_elems";var d=$("#"+$myApp.productCardClassName+e.attr("carid"));switch(t.data.func){case"compare_icon":var p=[],i=$.cookie(r);i&&(p=JSON.parse(i)),n?($.cookie(r,JSON.stringify(Array.from(new Set(p).add(a))),{expires:15,path:"/"}),d.find(".input_compare").prop("checked",!0)):(p=new Set(p),p.delete(a),$.cookie(r,JSON.stringify(Array.from(p)),{expires:15,path:"/"}),d.find(".input_compare").prop("checked",!1));break;case"favorite_icon":var o=[],i=$.cookie(c);i&&(o=JSON.parse(i)),n?($.cookie(c,JSON.stringify(Array.from(new Set(o).add(a))),{expires:15,path:"/"}),d.find(".input_favorite").prop("checked",!0)):(o=new Set(o),o.delete(a),$.cookie(c,JSON.stringify(Array.from(o)),{expires:15,path:"/"}),d.find(".input_favorite").prop("checked",!1));break}}function J(){$(document).on("mouseover",".car_card",{},j),$(document).on("mouseout",".extended_car_card",{},S),$(document).on("mousemove",".extended_car_card",{},S),$(document).on("mouseover",".ext_car_card_microphoto",{},G)}const y="ext_card_status";function j(t){let e=$(this),n=e.attr("carid");if(n==null||e.attr(y)=="active")return;if(e.attr("ext_card_id")){let o=e.width(),i=e.offset(),f=$("#"+e.attr("ext_card_id"));$(".extended_car_card").each(function(l,s){$(s).attr("id")!=f.attr("id")?$(s).addClass("d-none"):$(s).removeClass("d-none")}),f.offset({left:i.left-3,top:i.top-3}).width(o+6),$(".car_card[ext_card_status=active]").attr(y,""),e.attr(y,"active");return}$.ajax({url:"/get_extended_product_card_micro_photos",type:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{id:n},dataType:"json"}).done(function(o,i,f){if(!o.success){e.attr(y,""),console.log("ERROR responseData.success = 0 / ",i,f);return}d.find(".ext_card_empty_img"),d.find(".ext_car_card_microphoto_set").html(o.html)}).fail(function(o,i,f){e.attr(y,""),console.log("carCardMouseover > ОШИБКА AJAX запроса: "+i,o)});let a="ext_car_card"+n,r=e.width(),c=e.offset(),d=$("#"+a);d.length||(d=$("#extCard_FOR_CLONE").clone(),d.attr("id",a),$("body").append(d)),d.find(".card-img-top").attr("src",e.find(".card-img-top").attr("src")),d.attr("card_id",e.attr("id"));let p=e.find(".card_url").attr("href");d.find(".card_url").attr("href",p),d.find("a.btn").attr("href",p),d.find(".card-body").html(e.find(".card-body").html()),d.find(".card-body").append(e.find(".icon_compare").get(0).outerHTML),d.find(".card-body").append(e.find(".icon_favorite").get(0).outerHTML),d.find(".icon_compare").addClass("ext_card_icons"),d.find(".icon_favorite").addClass("ext_card_icons"),e.attr("ext_card_id",a),$(".extended_car_card").each(function(o,i){$(i).attr("id")!=d.attr("id")?$(i).addClass("d-none"):$(i).removeClass("d-none")}),d.offset({left:c.left-3,top:c.top-3}).width(r+6),$(".car_card[ext_card_status=active]").attr(y,""),e.attr(y,"active")}function S(t){t.stopImmediatePropagation();let e=$(this),n=e.attr("card_id");V(t.pageX,t.pageY,e)||(e.addClass("d-none"),$("#"+n).attr(y,""))}function V(t,e,n){let a=n.offset(),r=a.left+n.width(),c=a.top+n.height();return t>=a.left&&t<=r&&e>=a.top&&e<=c}function G(t){let e=$(this);find_parent(e,"extended_car_card").find("img.ext_car_card_photo").attr("src",e.attr("src"))}function B(){$(document).on("input","#search, #search_mobile",{dynamic:!0},A),$(document).on("focus","#search, #search_mobile",{focus:!0},F),$(document).on("blur","#search, #search_mobile",{focus:!1},F),$(document).on("submit ","#search_form",{dynamic:!1},A),$(document).on("click","#btn_search_submit",{dynamic:!1},A)}function A(t){if(typeof A.savedSearchPhrase>"u"&&(A.savedSearchPhrase=""),isMobileViewport())var e=".dynamic_search_results_mobile",n="#search_mobile";else var e=".dynamic_search_results",n="#search";var a=$(e),r=$(n).val();if(r.trim(),r.length<3){A.savedSearchPhrase=r,a.addClass("d-none");return}var c=r.split(" ");if(c=c.filter(function(o,i){return o.length>=2}),c.length!=0){r=c.slice(0,2).join(" ");var d,p;if(t.data.dynamic){if(t.preventDefault(),r==A.savedSearchPhrase)return;A.savedSearchPhrase=r,d="POST",p="/search"}else{d="GET",p="/search";return}$.ajax({url:p,type:d,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{search_str:r},dataType:"json"}).done(function(o,i,f){if(!o.success){a.addClass("d-none");return}a.removeClass("d-none"),a.html(o.html);var l=function(s){a.addClass("d-none"),$(document).off("click","*",l)};$(document).on("click","*",l)}).fail(function(o,i,f){console.log("DYNAMIC_SEARCH > ОШИБКА AJAX запроса: "+i,o)})}}function F(t){t.data.focus?$(".black_rect_fullscreen").removeClass("d-none"):$(".black_rect_fullscreen").addClass("d-none")}$(function(){P(),O(),q(),isMobileViewport()||J(),B()});
